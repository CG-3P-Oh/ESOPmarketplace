name: Simple FTP Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ncftp
        run: sudo apt-get update -qq && sudo apt-get install -y ncftp

      - name: Deploy to server via FTP
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          echo "ðŸš€ Starting deployment to new.esopmarketplace.com..."

          # Create .ncftp bookmarks for easy connection
          mkdir -p ~/.ncftp
          cat > ~/.ncftp/bookmarks << EOF
          esop,${FTP_SERVER},${FTP_USERNAME},${FTP_PASSWORD},,/home/esopmark/new.esopmarketplace.com,
          EOF

          # Upload only the mu-plugins directory for now (the critical file)
          echo "ðŸ“¤ Uploading mu-plugins directory..."
          ncftpput -R -v -u "${FTP_USERNAME}" -p "${FTP_PASSWORD}" "${FTP_SERVER}" /home/esopmark/new.esopmarketplace.com/wp-content/mu-plugins wp-content/mu-plugins/*

          echo "âœ… Deployment complete!"

      - name: Verify plugin file
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          echo "ðŸ“‹ Verifying plugin file was uploaded..."

          ncftpls -u "${FTP_USERNAME}" -p "${FTP_PASSWORD}" "ftp://${FTP_SERVER}/home/esopmark/new.esopmarketplace.com/wp-content/mu-plugins/esop-advisor-system.php"

          echo "âœ… Verification complete"
