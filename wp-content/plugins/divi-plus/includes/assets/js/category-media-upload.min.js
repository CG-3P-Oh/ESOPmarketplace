jQuery( document ).ready( function($) {

	// Upload button
	function dipl_upload_image( button ) {
		var frame;
		var button = $(button);

		frame = wp.media( {
			title: diplMediaUploadObj.frame_title,
			button: { text: diplMediaUploadObj.upload_button_text },
			multiple: false,
			library: { type: 'image' }
		} );

		frame.on( 'select', function() {
			var attachment = frame.state().get( 'selection' ).first().toJSON();
			var $container = button.closest( 'td, .form-field' );

			// Set the hidden field value correctly.
			$container.find( '#dipl_category_thumbnail' ).val( attachment.id );

			// Update the image preview.
			$container.find( '#dipl_category_thumbnail_preview img' ).attr( 'src', attachment.url );

			// Show the remove button.
			if ( attachment.id ) {
				$container.find( '.dipl_remove_category_image_button' ).show();
			}
		} );

		frame.open();
	}

	$( '.dipl_upload_category_image_button' ).on( 'click', function(e) {
		e.preventDefault();
		dipl_upload_image( this );
	} );

	$( '.dipl_remove_category_image_button' ).on( 'click', function() {
		$( this ).closest( 'td, .form-field' ).find( '#dipl_category_thumbnail_preview img' ).attr( 'src', diplMediaUploadObj.placeholder_image );
		$( this ).closest( 'td, .form-field' ).find( '#dipl_category_thumbnail' ).val( '' );
		$( this ).hide();
		return false;
	} );

	// Clean on add category form, when category hass been added.
	$( document ).ajaxComplete( function( event, request, options ) {
		if ( request && 4 === request.readyState && 200 === request.status
			&& options.data && 0 <= options.data.indexOf( 'action=add-tag' ) ) {

			var res = wpAjax.parseAjaxResponse( request.responseXML, 'ajax-response' );
			if ( ! res || res.errors ) {
				return;
			}
			// Clear Thumbnail fields on submit.
			$( '#dipl_category_thumbnail_preview' ).find( 'img' ).attr( 'src', diplMediaUploadObj.placeholder_image );
			$( '#dipl_category_thumbnail' ).val( '' );
			$( '.dipl_remove_category_image_button' ).hide();

			return;
		}
	} );

} ); // Over document ready.
