jQuery( document ).ready( function($) {

	// Function to get responsive font size.
	function getFontSize() {
		if ( window.innerWidth <= 480 ) return 10; // Mobile.
		if ( window.innerWidth <= 768 ) return 14; // Tablet.
		return 16;                                 // Desktop
	}

	// Function to get responsive chart height.
	function getChartHeight( $wrapper ) {
		if ( window.innerWidth <= 480 ) { // Mobile.
			return $wrapper.data( 'chart_height_phone' );
		}
		if ( window.innerWidth <= 768 ) { // Tablet.
			return $wrapper.data( 'chart_height_tablet' );
		}
		return $wrapper.data( 'chart_height' ) || 400; // Desktop.
	}

	// Function to initialize a single chart.
	function diplInitPieChart( $main ) {
		const $wrapper = $main.find( '.dipl_pie_chart_wrapper' );
		const $canvas  = $wrapper.find( 'canvas' )[0];

		if ( ! $canvas ) {
			return;
		}

		// Destroy previous chart if exists.
		if ( $canvas.chartInstance ) {
			$canvas.chartInstance.destroy();
		}

		// Parse data from data-chart attribute.
		let chartData = {};
		try {
			chartData = JSON.parse( $wrapper.attr('data-chart') );
		} catch (e) {
			console.error( 'Invalid chart data for: ', $main );
			return;
		}

		// Set chart height.
		const height = getChartHeight( $wrapper );
		$wrapper.css( 'height', height + 'px' );
		$canvas.height = height;

		// Normalize backgroundColor / borderColor keys.
		chartData.datasets.forEach( dataset => {
			if ( typeof dataset.backgroundColor === 'undefined' && dataset.backgroundcolor ) {
				dataset.backgroundColor = dataset.backgroundcolor;
			}
			if ( typeof dataset.borderColor === 'undefined' && dataset.bordercolor ) {
				dataset.borderColor = dataset.bordercolor;
				dataset.borderWidth = 1;
			}
		} );

		// Create Chart.js pie chart.
		$canvas.chartInstance = new Chart( $canvas.getContext('2d'), {
			type: 'pie',
			data: chartData,
			options: {
				responsive: true,
				maintainAspectRatio: false,
				plugins: {
					legend: { labels: { font: { size: getFontSize() } } }
				}
			}
		} );

		// Update font size on window resize
		$( window ).on( 'resize', function() {
			const height = getChartHeight( $wrapper );
			$wrapper.css( 'height', height + 'px' );
			$canvas.height = height;

			// Update font size.
			const size = getFontSize();
			$canvas.chartInstance.options.plugins.legend.labels.font.size = size;

			$canvas.chartInstance.resize(); // important!
			$canvas.chartInstance.update();
		} );
	}

	// Initialize all charts on page load.
	$( '.dipl_pie_chart' ).each( function() {
		diplInitPieChart( $(this) );
	} );
} ); // over document ready.
