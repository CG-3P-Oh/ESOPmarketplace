jQuery( document ).ready( function($) {
	$( document ).find( '.dipl_image_card_ticker' ).each( function() {

		let $thisObj   = $( this ),
			$wrapper   = $thisObj.find( '.dipl_image_card_ticker_wrapper' );

		let layout     = $wrapper.data( 'layout' ) ?? 'marquee';

		// create.
		let mm = gsap.matchMedia();

		// add a media query. When it matches, the associated function will run.
		mm.add( "(min-width: 1024px)", () => {
			if ( 'marquee' === layout ) {
				diplInitImageCardTickerMarquee( $wrapper );
			} else if ( '3d_circular' === layout ) {
				diplInitImageCardTicker3DCircle( $wrapper );
			} else if ( 'curve' === layout ) {
				diplInitImageCardTickerCurve( $wrapper );
			}
		} );
		// For tablet.
		mm.add( "(max-width: 1024px) and (min-width: 768px)", () => {
			if ( 'marquee' === layout ) {
				diplInitImageCardTickerMarquee( $wrapper, 'tablet' );
			} else if ( '3d_circular' === layout ) {
				diplInitImageCardTicker3DCircle( $wrapper, 'tablet' );
			} else if ( 'curve' === layout ) {
				diplInitImageCardTickerCurve( $wrapper, 'tablet' );
			}
		} );
		// For mobile.
		mm.add( "(max-width: 767px)", () => {
			if ( 'marquee' === layout ) {
				diplInitImageCardTickerMarquee( $wrapper, 'mobile' );
			} else if ( '3d_circular' === layout ) {
				diplInitImageCardTicker3DCircle( $wrapper, 'mobile' );
			} else if ( 'curve' === layout ) {
				diplInitImageCardTickerCurve( $wrapper, 'mobile' );
			}
		} );
	} );
} ); // Document ready.

// Init marquee effect.
function diplInitImageCardTickerMarquee( $wrapper, $device = 'desktop' ) {
	// gsap.registerPlugin( ScrollTrigger );

	let $innerWrap = $wrapper.find( '.dipl_image_card_ticker_inner' );

	let direction    = $wrapper.data( 'direction' ) || 'left',
		imgWidth     = $wrapper.data( 'image_width' ) || '200',
		imgHeight    = $wrapper.data( 'image_height' ) || '150',
		imgGap       = $wrapper.data( 'image_gap' ),
		speed        = $wrapper.data( 'ticker_speed' ) || '5',
		pauseOnHover = $wrapper.data( 'pause_on_hover' ) || 'on';

	// Check for responsive data.
	if ( 'desktop' !== $device ) {
		direction  = $wrapper.data( 'direction_' + $device ) || direction;
		imgWidth   = $wrapper.data( 'image_width_' + $device ) || imgWidth;
		imgHeight  = $wrapper.data( 'image_height_' + $device ) || imgHeight;
		imgGap     = $wrapper.data( 'image_gap_' + $device ) || imgGap;
		speed      = $wrapper.data( 'ticker_speed_' + $device ) || speed;
	}

	let isVertical = [ 'top', 'bottom' ].includes( direction );

	// This is to make zero value to work.
	if ( ( ! imgGap || '' === imgGap ) && ( 0 !== parseInt(imgGap) ) ) {
		imgGap = '30';
	}

	let $scWidth   = isVertical ? jQuery( window ).height() : jQuery( window ).width();
	let $imgSize   = isVertical ? +imgHeight : +imgWidth;

	// This needs to calc before adding html.
	let distance   = ( ( isVertical ? +imgHeight : +imgWidth ) + +imgGap ) * +$innerWrap.children().length;

	let amount     = Math.ceil( $scWidth / $imgSize );
		amount     = Math.ceil( amount / $innerWrap.children().length );

	let html = $innerWrap.html();
	for ( let i = 0; i < amount; i++ ) {
		const $clones = jQuery( html ).map( function () {
			return jQuery( this ).addClass( 'dipl-cloned-item' )[0];
		} );
		$innerWrap.append( $clones );
	}

	let [ startPos, endPos ] = [ 'right', 'bottom' ].includes( direction ) ? [ -distance, 0 ] : [ 0, -distance ];

	let prop = isVertical ? 'y' : 'x';
	if ( [ 'right', 'bottom' ].includes( direction ) ){
		gsap.set( $innerWrap, { [ prop ]: startPos } );
	}

	let $items = $innerWrap.children();
	$items.each( (i, card ) => {
		gsap.set( card, {
			width: imgWidth,
			height: imgHeight,
			marginRight: isVertical ? 0 : imgGap,
			marginBottom: isVertical ? imgGap : 0,
		} );
	} );

	let tween = gsap.to( $innerWrap, {
		[prop]: endPos,
		duration: speed,
		ease: 'none',
		repeat: -1,
		onRepeat: () => gsap.set( $innerWrap, { [prop]: startPos } )
	} );

	// if ( 'off' !== pauseOnHover ) {
		$innerWrap.on( 'mouseenter', 'img', () => tween.pause() );
		$innerWrap.on( 'mouseleave', 'img', () => tween.resume() );
	// }
	$wrapper.addClass( "marquee-inited" );
}

// Init 3d circle.
function diplInitImageCardTicker3DCircle( $wrapper, $device = 'desktop' ) {
	// gsap.registerPlugin( ScrollTrigger );

	let $innerWrap    = $wrapper.find( '.dipl_image_card_ticker_inner' );

	let direction     = $wrapper.data( 'direction' ) || 'left',
		imgWidth      = $wrapper.data( 'image_width' ) || '200',
		imgHeight     = $wrapper.data( 'image_height' ) || '150',
		imgGap        = $wrapper.data( 'image_gap' ) || '30',
		speed         = $wrapper.data( 'ticker_speed' ) || '5',
		pauseOnHover  = $wrapper.data( 'pause_on_hover' ) || 'on',
		totalCards    = $innerWrap.children().length,
		spacingFactor = 1; // keep it static.

	// Check for responsive data.
	if ( 'desktop' !== $device ) {
		direction  = $wrapper.data( 'direction_' + $device ) || direction;
		imgWidth   = $wrapper.data( 'image_width_' + $device ) || imgWidth;
		imgHeight  = $wrapper.data( 'image_height_' + $device ) || imgHeight;
		imgGap     = $wrapper.data( 'image_gap_' + $device ) || imgGap;
		speed      = $wrapper.data( 'ticker_speed_' + $device ) || speed;
	}

	let baseRadius    = ( imgWidth / 2 ) / Math.tan( Math.PI / totalCards );
	let radius        = baseRadius * spacingFactor + ( +imgGap / 2 );

	$wrapper.addClass( 'circle-carousel' );

	$innerWrap.children().each( ( i, card ) => {
		let angle = ( 360 / totalCards ) * i;
		gsap.set( card, {
			rotationY: angle,
			width: imgWidth,
			height: imgHeight,
			z: radius,
			transformOrigin: `center center -${radius}px`
		} );
	} );

	// Direction logic (360 or -360).
	let rotationAmount = (direction === 'left') ? 360 : -360;

	let tween = gsap.to( $innerWrap, {
		rotationY: `+=${rotationAmount}`,
		duration: speed,
		repeat: -1,
		ease: 'none',
		transformOrigin: 'center center',
		transformStyle: 'preserve-3d',
		overflow: 'visible',
		position: 'relative'
	} );

	// if ( 'off' !== pauseOnHover ) {
		$innerWrap.on( 'mouseenter', 'img', () => tween.pause() );
		$innerWrap.on( 'mouseleave', 'img', () => tween.resume() );
	// }
}

// Init Curve.
function diplInitImageCardTickerCurve( $wrapper, $device = 'desktop' ) {
	// gsap.registerPlugin( ScrollTrigger );

	let $innerWrap     = $wrapper.find( '.dipl_image_card_ticker_inner' );

	let direction      = $wrapper.data( 'direction' ) || 'left',
		imgWidth       = $wrapper.data( 'image_width' ) || '200',
		imgHeight      = $wrapper.data( 'image_height' ) || '150',
		imgGap         = $wrapper.data( 'image_gap' ) || '30',
		speed          = $wrapper.data( 'ticker_speed' ) || '5',
		pauseOnHover   = $wrapper.data( 'pause_on_hover' ) || 'on';

	// Check for responsive data.
	if ( 'desktop' !== $device ) {
		direction  = $wrapper.data( 'direction_' + $device ) || direction;
		imgWidth   = $wrapper.data( 'image_width_' + $device ) || imgWidth;
		imgHeight  = $wrapper.data( 'image_height_' + $device ) || imgHeight;
		imgGap     = $wrapper.data( 'image_gap_' + $device ) || imgGap;
		speed      = $wrapper.data( 'ticker_speed_' + $device ) || speed;
	}

	let totalItemWidth = ( +imgWidth + +imgGap ) * $innerWrap.children().length;

	let amount         = Math.ceil( jQuery(window).width() / imgWidth );
		amount         = Math.ceil( amount / $innerWrap.children().length );

	let html = $innerWrap.html();
	for ( let i = 0; i < amount; i++ ) {
		const $clones = jQuery( html ).map( function () {
			return jQuery( this ).addClass( 'dipl-cloned-item' )[0];
		} );

		// Append based on direction.
		if ( 'right' === direction ) {
			$innerWrap.prepend( $clones );
		} else {
			$innerWrap.append( $clones );
		}
	}

	$wrapper.addClass( 'curve-carousel' );

	let $items = $innerWrap.children();
	$items.each( (i, card) => {
		gsap.set( card, {
			width: imgWidth,
			height: imgHeight,
			marginRight: imgGap
		} );
	} );

	// Determine animation start and end positions
	let startX = 0;
	let endX   = -totalItemWidth;
	if ( direction === 'left' ) {
		startX = 0;
		endX   = -totalItemWidth;
	} else if ( direction === 'right' ) {
		startX = -totalItemWidth;
		endX   = 0;
	}

	// Set initial position.
	gsap.set( $innerWrap, { x: startX } );

	let tween = gsap.to( $innerWrap, {
		x: endX,
		duration: speed,
		ease: "none",
		repeat: -1,
		onRepeat: () => {
			gsap.set( $innerWrap, { x: startX } );
		}
	} );

	// Animate using GSAP
	let wrapWidth   = $wrapper.width(),
		wrapHalf    = wrapWidth / 2,
		wrapHeight  = $wrapper.height(),
		wrapHQart   = wrapHeight / 4,
		wrapH3Quart = wrapHQart * 3;
	let svgHtmlMac  = '<svg width="0" height="0" style="position:absolute"> <defs> <mask id="dipl_image_card_ticker_curve_mask" maskUnits="userSpaceOnUse" maskContentUnits="userSpaceOnUse"> <rect width="100%" height="100%" fill="black" /> <path d="M0,0 Q'+wrapHalf+','+wrapHQart+' '+wrapWidth+',0 V'+wrapHeight+' Q'+wrapHalf+','+wrapH3Quart+' 0,'+wrapHeight+' Z" fill="white" /> </mask> </defs> </svg>';
	let svgHtmlChr  = '<svg width="0" height="0" style="position:absolute"> <defs> <mask id="dipl_image_card_ticker_curve_mask" maskUnits="objectBoundingBox" maskContentUnits="objectBoundingBox"> <rect width="100%" height="100%" fill="black" /> <path d="M0,0 Q0.5,0.25 1,0 V1 Q0.5,0.75 0,1 Z" fill="white" /> </mask> </defs> </svg>';

	if (/^((?!chrome|android).)*safari/i.test( navigator.userAgent) ) {
		$wrapper.find( 'svg' ).remove();
		$wrapper.append( svgHtmlMac );
	} else{
		$wrapper.find( 'svg' ).remove();
		$wrapper.append( svgHtmlChr );
	}

	// if ( 'off' !== pauseOnHover ) {
		$innerWrap.on( 'mouseenter', 'img', () => tween.pause() );
		$innerWrap.on( 'mouseleave', 'img', () => tween.resume() );
	// }
}
