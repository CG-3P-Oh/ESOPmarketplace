(function( $ ) {
	$.fn.DiviPlusTeamGridPagination = function( $options = {} ) {
		let $defaults = {
				paginationClass: 'dipl_team_grid_pagination',
				hideOnlyOnePage: true,
				totalPages: 1,
				visiblePages: 10,
				startPage: 1,
				initiateStartPageClick: false,
				first: false,
				last: false,
				prev: false,
				next: false,
			},
			$pagination = this;
		
		$options = $.extend({}, $defaults, $options);
		$pagination.twbsPagination($options);
	}
} ( jQuery ) );

function diplTeamGridGetQueryVars() {
	let $vars    = {},
		$hashes  = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&'),
		$hash;
	
	for( let i = 0; i < $hashes.length; i++ ) {
		$hash = $hashes[i].split('=');
		$vars[$hash[0]] = $hash[1];
	}

	return $vars;
}

jQuery(function($) {
	dipl_calc_overlay_height();
	
	/* Module: TeamGrid */
	if ( $('.dipl_team_grid').find('.dipl_team_link').length > 0 ) {
		$('body').on( 'click', '.dipl_team_link', function(e) {
			if ( $(e.target).is( $(this).find('.dipl_team_member_social_icon') ) ) {
				return;
			}
			e.preventDefault();
			let link    = $(this).data('link'),
				target  = $(this).data('link_target');
			window.open( link, target );
		});
	}

	// Module: TeamGrid.
	if ( $('.dipl_team_grid').find('.dipl_team_popup').length > 0 ) {
		$('body').on( 'click', '.dipl_team_popup', function(e) {
			if ( $(e.target).is( $(this).find('.dipl_team_member_social_icon') ) ) {
				return;
			}
			e.preventDefault();
			
			let $this = $(this).closest('.dipl_team_popup');
			let $wrap = $this.parents( '.dipl_team_grid_container' );
			if ( ! $this.hasClass( 'dipl_team_grid_item' ) ) {
				$this = $this.parents( '.dipl_team_grid_item' );
			}

			let $globProps           = $wrap.data(),
				$thisProps           = $this.data(),
				$position            = $this.data('close_icon_position'),
				$close_icon_position = 'inside' === $position ? true : false;

			let $props = $.extend( {}, $globProps, $thisProps );

			$this.addClass('dipl_team_lightbox_loader');
			$.ajax({
				type: 'POST',  
				url: DiviPlusTeamGridData.ajaxurl,
				data: {
					action: 'dipl_get_teamgrid_page',
					dipl_team_popup_nonce: DiviPlusTeamGridData.ajaxnonce,
					props: $props
				},
				success: function(response) {
					let $orderClass = $this.closest('.dipl_team_grid').prop('class').match(/(dipl_team_grid\_[^\s]*)/)[0] + '_lightbox';
					$this.removeClass('dipl_team_lightbox_loader');
					$.magnificPopup.open({
						preloader: true,
						items: {
							src: $(response),
							type: 'inline'
						},
						callbacks: {
							open: function() {
								if ( $('body').find('.dipl_team_member_lightbox .dipl_skill_bar_wrapper').length > 0 ) {
									if ( $('.dipl_team_member_lightbox').find('.dipl_filled_bar').length > 0 ) {
										$('.dipl_team_member_lightbox').find('.dipl_filled_bar').each(function(){
											let $this = $(this);
											$this.waypoint({
												handler: function() {
													let width = $this.data('percent');
													$this.css('width', width);
												},
												context: $this
											});
										});
									}
									if ( $('.dipl_team_member_lightbox').find('.dipl_bar_counter_chunks').length > 0 ) {
										$('.dipl_team_member_lightbox').find('.dipl_bar_counter_filled_chunks').each(function() {
											let $this = $(this);
											$this.waypoint({
												handler: function() {
													$this.addClass('dipl_animate_filled');
												},
												context: $this
											});
										});
									}
								}
							},
						},
						closeOnContentClick: false,
						closeBtnInside: $close_icon_position,
						mainClass: 'dipl_team_member_lightbox ' + $orderClass
					});
				},
				error: function(){

				}
			});
		});
	}

	if ( $('body').find('.dipl_team_grid').length > 0 ) {
		$('.dipl_team_grid').each(function(){
			let $this = $(this);

			/* Pagination */
			if ( $this.find('.dipl_team_grid_pagination_wrapper').length > 0 ) {
				let $pagination_wrapper = $this.find('.dipl_team_grid_pagination_wrapper'),
					$pagination         = $pagination_wrapper.find('ul'),
					$include_categories = $pagination_wrapper.data('include_categories'),
					$perPage            = isNaN( $pagination_wrapper.data('posts_number') ) || 0 === parseInt( $pagination_wrapper.data('posts_number') ) ? -1 : parseInt( $pagination_wrapper.data('posts_number') ),
					$totalPages         = isNaN( $pagination_wrapper.data('total_pages') ) || 0 === parseInt( $pagination_wrapper.data('total_pages') ) ? 1 : parseInt( $pagination_wrapper.data('total_pages') ),
					$options            = {
						totalPages: $totalPages,
						onPageClick: function (event, page) {
							let $props = $pagination_wrapper.data();
							$props['page'] = page;
							$this.fadeTo( '100', 0.2 );
							$.ajax({
								type: 'POST',  
								url: DiviPlusTeamGridData.ajaxurl,
								data: {
									action: 'dipl_get_team_members', 
									dipl_get_team_members_nonce: DiviPlusTeamGridData.ajaxnonce,
									props: $props,
								},
								success: function(response) {
									$this.fadeTo( '100', 1 );
									if ( response.success ) {
										$this.find('.dipl_team_grid_items').fadeOut('fast', function(){
											$(this).html(response.items);
											$(this).fadeIn('fast', function(){
												dipl_calc_overlay_height();
											});
										});
									}
								}
							});

							let topHeaderHeight     = 0,
								mainHeaderHeight    = 0,
								tbHeaderHeight      = 0;

							if ( $('body').find('#top-header').length > 0 && $('body').hasClass('et_fixed_nav') ) {
								topHeaderHeight = parseFloat( $('#top-header').innerHeight() );
							}
							
							if ( $('body').find('#main-header').length > 0 && $('body').hasClass('et_fixed_nav') ) {
								mainHeaderHeight = parseFloat( $('#main-header').innerHeight() );
							}

							if ( $('body').find('.et-l--header').length > 0 && $('body').find('.et-l--header .et_builder_inner_content').hasClass('has_et_pb_sticky') ) {
								tbHeaderHeight = parseFloat( $('.et-l--header').innerHeight() );
							}

							let headerHeight = topHeaderHeight + mainHeaderHeight + tbHeaderHeight + 50;
							$( 'html, body' ).animate({
								scrollTop: ( $this.offset().top - headerHeight )
							});
						}
					};

				if ( 'on' === $pagination_wrapper.data('show_prev_next') ) {
					$options.prev = $pagination_wrapper.data('prev_text');
					$options.next = $pagination_wrapper.data('next_text');
				}

				$pagination.DiviPlusTeamGridPagination( $options );

				$this.find('.dipl-team-items-categories li').on('click', function() {
					if ( $(this).hasClass('dipl-team-active-category') ) {
						return false;
					}

					$(this).closest('.dipl-team-items-categories').find('li').removeClass('dipl-team-active-category');
					$(this).addClass('dipl-team-active-category');
					let $props      = $pagination_wrapper.data(),
						$category   = $(this).data('id');
						
					$props['page'] = 1;

					if ( '' !== $category ) {
						$props['include_categories']    = $category;
						$props['tax_query_field']       = 'term_id';
					} else {
						$props['include_categories']    = $include_categories;
						$props['tax_query_field']       = 'term_id';
					}

					$this.fadeTo( '100', 0.2 );
					$.ajax({
						type: 'POST',  
						url: DiviPlusTeamGridData.ajaxurl,
						data: {
							action: 'dipl_get_team_members', 
							dipl_get_team_members_nonce: DiviPlusTeamGridData.ajaxnonce,
							props: $props
						},
						success: function(response) {
							$this.fadeTo( '100', 1 );
							if ( response.success ) {
								$this.find('.dipl_team_grid_items').fadeOut('fast', function(){
									$(this).html(response.items);
									$(this).fadeIn('fast', function(){
										dipl_calc_overlay_height();
									});
								});
								
								/* Re-render Pagination */
								let $perPage    = isNaN( $pagination_wrapper.data('posts_number') ) || 0 === parseInt( $pagination_wrapper.data('posts_number') ) ? -1 : parseInt( $pagination_wrapper.data('posts_number') ),
									$totalPages = parseInt( response.total_pages ),
									$options    = {
										totalPages: $totalPages,
										onPageClick: function (event, page) {
											$props['page'] = page;
											$this.fadeTo( '100', 0.2 );
											$.ajax({
												type: 'POST',  
												url: DiviPlusTeamGridData.ajaxurl,
												data: {
													action: 'dipl_get_team_members', 
													dipl_get_team_members_nonce: DiviPlusTeamGridData.ajaxnonce,
													props: $props
												},
												success: function(response) {
													$this.fadeTo( '100', 1 );
													if ( response.success ) {
														$this.find('.dipl_team_grid_items').fadeOut('fast', function(){
															$(this).html(response.items);
															$(this).fadeIn('fast', function(){
																dipl_calc_overlay_height();
															});
														});
													}
												}
											});

											if ( $this.offset().top > 0 ) {
												let topHeaderHeight     = 0,
													mainHeaderHeight    = 0,
													tbHeaderHeight      = 0;

												if ( $('body').find('#top-header').length > 0 && $('body').hasClass('et_fixed_nav') ) {
													topHeaderHeight = parseFloat( $('#top-header').innerHeight() );
												}
												
												if ( $('body').find('#main-header').length > 0 && $('body').hasClass('et_fixed_nav') ) {
													mainHeaderHeight = parseFloat( $('#main-header').innerHeight() );
												}

												if ( $('body').find('.et-l--header').length > 0 && $('body').find('.et-l--header .et_builder_inner_content').hasClass('has_et_pb_sticky') ) {
													tbHeaderHeight = parseFloat( $('.et-l--header').innerHeight() );
												}

												let headerHeight = topHeaderHeight + mainHeaderHeight + tbHeaderHeight + 50;
												$( 'html, body' ).animate({
													scrollTop: ( $this.offset().top - headerHeight )
												});
											}
										}
									};

								if ( 'on' === $pagination_wrapper.data('show_prev_next') ) {
									$options.prev = $pagination_wrapper.data('prev_text');
									$options.next = $pagination_wrapper.data('next_text');
								}

								$pagination.twbsPagination('destroy');
								$pagination.DiviPlusTeamGridPagination( $options );
							}
						}
					});
				});
			} else {
				let $include_categories = $this.find('.dipl-team-items-categories').data('include_categories');
				$this.find('.dipl-team-items-categories li').on('click', function() {
					if ( $(this).hasClass('dipl-team-active-category') ) {
						return false;
					}

					$(this).closest('.dipl-team-items-categories').find('li').removeClass('dipl-team-active-category');
					$(this).addClass('dipl-team-active-category');

					let $category = $(this).data('id'),
						$props = $this.find('.dipl-team-items-categories').data();

					if ( '' !== $category ) {
						$props['include_categories']    = $category;
						$props['tax_query_field']       = 'term_id';
					} else {
						$props['include_categories']    = $include_categories;
						$props['tax_query_field']       = 'term_id';
					}

					$this.fadeTo( '100', 0.2 );
					$.ajax({
						type: 'POST',  
						url: DiviPlusTeamGridData.ajaxurl,
						data: {
							action: 'dipl_get_team_members', 
							dipl_get_team_members_nonce: DiviPlusTeamGridData.ajaxnonce,
							props: $props
						},
						success: function(response) {
							$this.fadeTo( '100', 1 );
							if ( response.success ) {
								$this.find('.dipl_team_grid_items').fadeOut('fast', function(){
									$(this).html(response.items);
									$(this).fadeIn('fast', function(){
										dipl_calc_overlay_height();
									});
								});
							}
						}
					});
				});
			}
		});
	}
	
	function dipl_calc_overlay_height() {
		let $winWidth = parseFloat( $(window).width() );

		if ( $('.dipl_team_grid').find('.layout1').length > 0 ) {
			$('.dipl_team_grid .layout1').find('.dipl_team_grid_item').each(function(){
				let $paddingTopDesktop      = parseFloat( $(this).data('padding_top_desktop') ),
					$paddingTopTablet       = parseFloat( $(this).data('padding_top_tablet') ),
					$paddingTopPhone        = parseFloat( $(this).data('padding_top_phone') ),
					$paddingBottomDesktop   = parseFloat( $(this).data('padding_bottom_desktop') ),
					$paddingBottomTablet    = parseFloat( $(this).data('padding_bottom_tablet') ),
					$paddingBottomPhone     = parseFloat( $(this).data('padding_bottom_phone') ),
					$paddingDesktop         = $paddingTopDesktop + $paddingBottomDesktop,
					$paddingTablet          = $paddingTopTablet + $paddingBottomTablet,
					$paddingPhone           = $paddingTopPhone + $paddingBottomPhone,
					$padding                = $winWidth > 980 ? $paddingDesktop : $winWidth < 768 ? $paddingPhone : $paddingTablet,
					$innerHeight            = $(this).find(".dipl_team_member_visible_wrapper").length > 0 ? parseFloat( $(this).find(".dipl_team_member_visible_wrapper").height() ) : 0,
					$translate              = $padding + $innerHeight;
				if ( 0 === $innerHeight ) {
					$(this).find('.dipl_team_overlay_wrapper').css('transform', 'translateY(100%)');    
				} else {
					$(this).find('.dipl_team_overlay_wrapper').css('transform', 'translateY(calc(100% - '+$translate +'px ))');
				}
			});
		}

		 if ( $('.dipl_team_grid').find('.layout2').length > 0 ) {
			$('.dipl_team_grid .layout2').find('.dipl_team_grid_item').each(function(){
				let $paddingTopDesktop      = parseFloat( $(this).data('padding_top_desktop') ),
					$paddingTopTablet       = parseFloat( $(this).data('padding_top_tablet') ),
					$paddingTopPhone        = parseFloat( $(this).data('padding_top_phone') ),
					$paddingBottomDesktop   = parseFloat( $(this).data('padding_bottom_desktop') ),
					$paddingBottomTablet    = parseFloat( $(this).data('padding_bottom_tablet') ),
					$paddingBottomPhone     = parseFloat( $(this).data('padding_bottom_phone') ),
					$paddingDesktop         = $paddingTopDesktop + $paddingBottomDesktop,
					$paddingTablet          = $paddingTopTablet + $paddingBottomTablet,
					$paddingPhone           = $paddingTopPhone + $paddingBottomPhone,
					$padding                = $winWidth > 980 ? $paddingDesktop : $winWidth < 768 ? $paddingPhone : $paddingTablet,
					$innerHeight            = $(this).find(".dipl_team_member_visible_wrapper").length > 0 ? parseFloat( $(this).find(".dipl_team_member_visible_wrapper").height() ) : 0,
					$translate              = $padding + $innerHeight;
				if ( 0 === $innerHeight ) {
					$(this).find('.dipl_team_overlay_wrapper').css('transform', 'translateY(100%)');    
				} else {
					$(this).find('.dipl_team_overlay_wrapper').css('transform', 'translateY(calc(100% - '+$translate +'px ))');
				}
			} );
		}
	}

	$(window).on('resize', function() {
		dipl_calc_overlay_height();
	} );
} );
