// This script is loaded both on the frontend page and in the Visual Builder.
( function( $ ) {
	$.fn.DiviFilterableGalleryInsertAt = function( index, element ) {
		let lastIndex = this.children().length;
		if ( index < 0 ) {
			index = Math.max(0, lastIndex + 1 + index);
		}
		this.append( element );
		if ( index < lastIndex ) {
			this.children().eq(index).before(this.children().last());
		}
		return this;
	}

	$.fn.DiviFilterableGalleryPagination = function( $options = {} ) {
		let $defaults = {
				paginationClass: 'dipl_filterable_gallery_pagination',
				hideOnlyOnePage: true,
				totalPages: 1,
				visiblePages: 10,
				startPage: 1,
				initiateStartPageClick: false,
				first: false,
				last: false,
				prev: false,
				next: false,
			},
			$pagination = this;
		
		$options = $.extend({}, $defaults, $options);
		$pagination.twbsPagination($options);
	}
} ( jQuery ) );

jQuery( function($) {
	if ( $('body').find('.dipl_filterable_gallery').length > 0 ) {
		$('.dipl_filterable_gallery').each(function(){
			let $this       = $(this),
				$wrapper    = $this.find('.dipl_filterable_gallery_wrapper'),
				$options    = {
					itemSelector: '.dipl_filterable_gallery_item',
					layoutMode: 'masonry',
					percentPosition: true,
					resize: true,
					masonry: {
						columnWidth: '.dipl_filterable_gallery_item',
						gutter: '.dipl_filterable_gallery_item_gutter'
					},
					transitionDuration: parseInt( $wrapper.data('isotope_transition_duration') ),
				};

			let $gallery = $wrapper.isotope($options);

			$gallery.imagesLoaded( function() {
				$gallery.isotope('layout');
				$gallery.isotope('reloadItems');
			} );

			/* Pagination */
			if ( $this.find('.dipl_filterable_gallery_pagination_wrapper').length > 0 ) {
				let $pagin_wrap = $this.find('.dipl_filterable_gallery_pagination_wrapper'),
					$pagination = $pagin_wrap.find('ul'),
					$perPage    = isNaN( $pagin_wrap.data('number_of_images') ) || 0 === parseInt( $pagin_wrap.data('number_of_images') ) ? 20 : parseInt( $pagin_wrap.data('number_of_images') ),
					$totalPages = isNaN( $pagin_wrap.data('total_pages') ) || 0 === parseInt( $pagin_wrap.data('total_pages') ) ? 1 : parseInt( $pagin_wrap.data('total_pages') ),
					$options    = {
						totalPages: $totalPages,
						onPageClick: function (event, page) {
							let $props = $pagin_wrap.data();
							if ( $wrapper.find('.dipl_filterable_gallery_item_page_'+page).length > 0 ) {
								$gallery.isotope( {
									filter: function() {
										if ( $(this).hasClass( 'dipl_filterable_gallery_item_page_' + page ) ) {
											return $(this);
										}
									}
								} ).isotope( 'revealItemElements', $wrapper.find( '.dipl_filterable_gallery_item_page_' + page ) ).isotope('layout');
							} else {
								$props['page'] = page;
								$wrapper.fadeTo( '100', 0.2 );
								$.ajax( {
									type: 'POST',  
									url: DiviPlusFrontendData.ajaxurl,
									data: {
										action: 'dipl_get_images', 
										dipl_get_images_nonce: DiviPlusFrontendData.ajaxnonce,
										props: $props
									},
									success: function(response) {
										if ( response.success ) {
											let $elements = $( response.items );
											$gallery.append( $elements ).isotope( 'appended', $elements );
											$gallery.isotope( {
												filter: function() {
													if ( $(this).hasClass('dipl_filterable_gallery_item_page_' + page) ) {
														return $(this);
													}
												}
											} ).isotope( 'revealItemElements', $wrapper.find('.dipl_filterable_gallery_item_page_' + page) ).isotope('layout');
											$wrapper.fadeTo( '100', 1 );
										}
									}
								} );
							}

							if ( $this.offset().top > 0 ) {
								let topHeaderHeight     = 0,
									mainHeaderHeight    = 0,
									tbHeaderHeight      = 0;

								if ( $('body').find('#top-header').length > 0 && $('body').hasClass('et_fixed_nav') ) {
									topHeaderHeight = parseFloat( $('#top-header').innerHeight() );
								}
								if ( $('body').find('#main-header').length > 0 && $('body').hasClass('et_fixed_nav') ) {
									mainHeaderHeight = parseFloat( $('#main-header').innerHeight() );
								}
								if ( $('body').find('.et-l--header').length > 0 && $('body').find('.et-l--header .et_builder_inner_content').hasClass('has_et_pb_sticky') ) {
									tbHeaderHeight = parseFloat( $('.et-l--header').innerHeight() );
								}

								let headerHeight = topHeaderHeight + mainHeaderHeight + tbHeaderHeight + 50;
								$( 'html, body' ).animate( {
									scrollTop: ( $this.offset().top - headerHeight )
								} );
							}
						}
					};

				if ( 'on' === $pagin_wrap.data( 'show_prev_next' ) ) {
					$options.prev = $pagin_wrap.data( 'prev_text' );
					$options.next = $pagin_wrap.data( 'next_text' );
				}

				$pagination.DiviFilterableGalleryPagination( $options );
			}

			/* Category Filter */
			let $detachedImages  = [];
			let $detachedIndices = [];
			if ( $this.find('.dipl_filterable_gallery_pagination_wrapper').length > 0 ) {
				let $pagin_wrap         = $this.find('.dipl_filterable_gallery_pagination_wrapper'),
					$pagination         = $pagin_wrap.find('ul'),
					$include_categories = $pagin_wrap.data('include_categories');

				$this.find('.dipl_filterable_gallery_filter_categories li').on( 'click', function() {
					if ( $(this).hasClass( 'dipl_filterable_gallery_active_category' ) ) {
						return false;
					}

					if ( $detachedImages && $detachedIndices && $detachedIndices.length === $detachedImages.length ) {
						$.map( $detachedImages, function( value, key ) {
							$wrapper.DiviFilterableGalleryInsertAt( $detachedIndices[key], $(value) );
						} );
					} else if ( $detachedImages ) {
						$wrapper.append( $detachedImages );
					}

					$( this ).parent( '.dipl_filterable_gallery_filter_categories' ).find( 'li' ).removeClass( 'dipl_filterable_gallery_active_category' );
					$( this ).addClass( 'dipl_filterable_gallery_active_category' );
					let $category = $(this).data('category'),
						$props    = $pagin_wrap.data();
					
					$props['page'] = 1;

					if ( '' !== $category ) {
						if ( 1 !== parseInt( $props['total_pages'] ) ) {
							$props['include_categories'] = $category;
							$props['tax_query_field']    = 'term_id';
						} else {
							let $elements = [];
							$wrapper.find('.dipl_filterable_gallery_item img').each(function(){
								if ( $(this).data('categories') ) {
									let $imageCats = $(this).attr('data-categories').split(',');
									$imageCats = $.map( $imageCats, function( a ) {
									  return parseInt(a);
									} );
									if ( -1 === $.inArray( $category, $imageCats ) ) {
										$detachedIndices.push( $(this).closest('.dipl_filterable_gallery_item').index() );
									} else {
										$elements.push($(this).closest('.dipl_filterable_gallery_item'));
									}
								} else {
									$detachedIndices.push( $(this).closest('.dipl_filterable_gallery_item').index() );
								}
							} );
							$gallery.isotope( {
								filter: function() {
									if ( $(this).find('img').data('categories') ) {
										let $imageCats = $(this).find('img').attr('data-categories').split(',');
										$imageCats = $.map( $imageCats, function( a ) {
										  return parseInt(a);
										} );
										if ( -1 !== $.inArray( $category, $imageCats ) ) {
											return $(this);
										} else {
											$detachedImages.push( $(this).detach() );
										}
									} else {
										$detachedImages.push( $(this).detach() );
									}
									
								}
							} ).isotope( 'revealItemElements', $elements ).isotope('layout');
						}
					} else {
						$props['include_categories'] = $include_categories;
						$props['tax_query_field']    = 'term_id';
						if ( 1 === parseInt( $props['total_pages'] ) ) {
							$gallery.isotope({ filter: '*' });
						}
					}

					if ( 1 !== parseInt( $props['total_pages'] ) ) {
						$wrapper.fadeTo( '100', 0.2 );
						$.ajax({
							type: 'POST',  
							url: DiviPlusFrontendData.ajaxurl,
							data: {
								action: 'dipl_get_images', 
								dipl_get_images_nonce: DiviPlusFrontendData.ajaxnonce,
								props: $props
							},
							success: function(response) {
								if ( response.success ) {
									let $elements = $(response.items);
									$wrapper.find('.dipl_filterable_gallery_item').remove();
									$gallery.append( $elements ).isotope( 'appended', $elements );
									$gallery.isotope( {
										filter: function() {
											if ( $(this).find('img').attr('data-categories') ) {
												let $imageCats = $(this).find('img').attr('data-categories').split(',');
												$imageCats = $.map( $imageCats, function( a ) {
													return parseInt(a);
												} );
												if ( '' === $category || -1 !== $.inArray( $category, $imageCats ) ) {
													return true;
												}
												return false;
											} else if ( '' === $category ) {
												return true;
											}
										}
									} );
									$wrapper.fadeTo( '100', 1 );

									/* Re-render Pagination */
									let $perPage    = isNaN( $pagin_wrap.data('number_of_images') ) || 0 === parseInt( $pagin_wrap.data('number_of_images') ) ? 20 : parseInt( $pagin_wrap.data('number_of_images') ),
										$totalPages = parseInt( response.total_pages ),
										$options    = {
											initiateStartPageClick: false,
											totalPages: $totalPages,
											onPageClick: function (event, page) {
												if ( $wrapper.find('.dipl_filterable_gallery_item_page_'+page).length > 0 ) {
													$gallery.isotope({
														filter: function() {
															if ( $(this).hasClass('dipl_filterable_gallery_item_page_'+page) ) {
																return $(this);
															}
														}
													} ).isotope( 'revealItemElements', $wrapper.find('.dipl_filterable_gallery_item_page_'+page) ).isotope( 'layout' );
												} else {
													$props['page'] = page;
													$wrapper.fadeTo( '100', 0.2 );
													$.ajax({
														type: 'POST',  
														url: DiviPlusFrontendData.ajaxurl,
														data: {
															action: 'dipl_get_images', 
															dipl_get_images_nonce: DiviPlusFrontendData.ajaxnonce,
															props: $props
														},
														success: function(response) {
															if ( response.success ) {
																let $elements = $(response.items);
																$gallery.append( $elements ).isotope( 'appended', $elements );
																$gallery.isotope( {
																	filter: function() {
																		if ( $(this).hasClass('dipl_filterable_gallery_item_page_'+page) ) {
																			return $(this);
																		}
																	}
																} ).isotope( 'revealItemElements', $wrapper.find('.dipl_filterable_gallery_item_page_'+page) ).isotope('layout');
																$wrapper.fadeTo( '100', 1 );
															}
														}
													} );
												}

												if ( $this.offset().top > 0 ) {
													let topHeaderHeight     = 0,
														mainHeaderHeight    = 0,
														tbHeaderHeight      = 0;

													if ( $('body').find('#top-header').length > 0 && $('body').hasClass('et_fixed_nav') ) {
														topHeaderHeight = parseFloat( $('#top-header').innerHeight() );
													}
													if ( $('body').find('#main-header').length > 0 && $('body').hasClass('et_fixed_nav') ) {
														mainHeaderHeight = parseFloat( $('#main-header').innerHeight() );
													}
													if ( $('body').find('.et-l--header').length > 0 && $('body').find('.et-l--header .et_builder_inner_content').hasClass('has_et_pb_sticky') ) {
														tbHeaderHeight = parseFloat( $('.et-l--header').innerHeight() );
													}

													let headerHeight = topHeaderHeight + mainHeaderHeight + tbHeaderHeight + 50;
													$( 'html, body' ).animate( {
														scrollTop: ( $this.offset().top - headerHeight )
													} );
												}
											}
										};

									if ( 'on' === $pagin_wrap.data('show_prev_next') ) {
										$options.prev = $pagin_wrap.data('prev_text');
										$options.next = $pagin_wrap.data('next_text');
									}
									$pagination.twbsPagination('destroy');
									$pagination.DiviFilterableGalleryPagination( $options );
								}
							}
						} );
					}
				} );
			} else {
				let $include_categories = $this.find('.dipl_filterable_gallery_filter_wrapper').data('include_categories');
				$this.on('click', '.dipl_filterable_gallery_filter_categories li', function(){
					if ( $(this).hasClass( 'dipl_filterable_gallery_active_category' ) ) {
						return false;
					}

					if ( $detachedImages && $detachedIndices && $detachedIndices.length === $detachedImages.length ) {
						$.map( $detachedImages, function( value, key ) {
							$wrapper.DiviFilterableGalleryInsertAt( $detachedIndices[key], $(value) );
						});
					} else if ( $detachedImages ) {
						$wrapper.append($detachedImages);
					}

					$(this).parent('.dipl_filterable_gallery_filter_categories').find( 'li' ).removeClass( 'dipl_filterable_gallery_active_category' );
					$(this).addClass('dipl_filterable_gallery_active_category');

					let $this = $(this),
						$category = $(this).data('category'),
						$props = $(this).closest('.dipl_filterable_gallery_filter_wrapper').data();

					if ( '' !== $category ) {
						$props['include_categories']    = $category;
						$props['tax_query_field']       = 'term_id';
					} else {
						$props['include_categories']    = $include_categories;
						$props['tax_query_field']       = 'term_id';
					}

					$wrapper.fadeTo( '100', 0.2 );
					$.ajax({
						type: 'POST',  
						url: DiviPlusFrontendData.ajaxurl,
						data: {
							action: 'dipl_get_images', 
							dipl_get_images_nonce: DiviPlusFrontendData.ajaxnonce,
							props: $props
						},
						success: function(response) {
							if ( response.success ) {
								let $elements = $(response.items);
								$wrapper.find('.dipl_filterable_gallery_item').remove();
								$gallery.append( $elements ).isotope( 'appended', $elements );
								if ( '' !== $category ) {
									$gallery.isotope({
										filter: function() {
											if ( $(this).find('img').data('categories') ) {
												let $imageCats = $(this).find('img').attr('data-categories').split(',');
												$imageCats = $.map( $imageCats, function( a ) {
													return parseInt(a);
												});
												if ( -1 !== $.inArray( $category, $imageCats ) ) {
													return $(this);
												}
											}
										}
									});
								} else {
									$gallery.isotope({ filter: '*' });
								}
								$wrapper.fadeTo( '100', 1 );
							}
						}
					});

				});
			}
			
			/* Lightbox */
			if ( 'lightbox' === $wrapper.data('on_click_trigger') ) {
				let $orderClass     = $this.prop('class').match(/(dipl_filterable_gallery\_[^\s]*)/)[0] + '_lightbox',
					$effect         = $wrapper.data('lightbox_effect'),
					$zoom           = 'zoom' === $effect ? true : false,
					$duration       = 'none' !== $effect ? parseInt( $wrapper.data('lightbox_transition_duration') ) : 0,
					$navigation     = 'on' === $wrapper.data('enable_navigation') ? true : false,
					$mainClass      = 'mfp-img-mobile dipl_filterable_gallery_lightbox ' + $orderClass + ' dipl_mfp_' + $effect,
					$prependTo      = $('body');

				if ( $('body').hasClass('et-tb-has-template') ) {
					if ( $orderClass.includes('_tb_header') ) {
						$prependTo = $('body').find('#page-container').find('#et-boc .et-l--header');
					} else if ( $orderClass.includes('_tb_body') ) {
						$prependTo = $('body').find('#page-container').find('#et-boc .et-l--body');  
					} else if ( $orderClass.includes('_tb_footer') ) {
						$prependTo = $('body').find('#page-container').find('#et-boc .et-l--footer');
					}
				}

				$wrapper.magnificPopup( {
					delegate: '.dipl_filterable_gallery_item',
					type: 'image',
					prependTo: $prependTo,
					closeOnContentClick: false,
					removalDelay: $duration,
					closeBtnInside: false,
					mainClass: $mainClass,
					gallery: {
						enabled: $navigation,
						navigateByImgClick: false,
						tPrev: '',
						tNext: '',
						tCounter: ''
					},
					zoom: {
						enabled: $zoom,
						duration: $duration,
						easing: 'ease-in-out',
					},
					image: {
						markup: '<div class="mfp-figure">'+
								'<div class="mfp-close"></div>'+
								'<div class="mfp-img"></div>'+
								'<div class="mfp-bottom-bar">'+
								  '<div class="mfp-title"></div>'+
								'</div>'+
							  '</div>',
						titleSrc: function(item) {
							return item.el.find('.dipl_filterable_gallery_title_caption_wrapper').length > 0 ? item.el.find('.dipl_filterable_gallery_title_caption_wrapper').html() : '';
						},
						tError: '<a href="%url%">The image</a> could not be loaded.',
					},
					allowHTMLInTemplate: true
				} );

				let $magnificPopup = $.magnificPopup.instance;
				$magnificPopup.open = function(data) {
					if ( '.dipl_filterable_gallery_item' === data.delegate ) {
						let $items = [];
						$.each( data.items, function( key, value ) {
							if ( $(value).is(':visible') && 0 !== parseFloat( $(value).css('opacity') ) ) {
								$items.push(value);
							}
						});
						data.items = $($items);
					}
					$.magnificPopup.proto.open.call(this, data);
				};

				$('body').on( 'swiperight', '.dipl_filterable_gallery_lightbox .mfp-img', function() {
					$magnificPopup.prev();
				} );
				$('body').on( 'swipeleft', '.dipl_filterable_gallery_lightbox .mfp-img', function() {
					$magnificPopup.next();
				} );
			}

			$(window).resize( function() {
				$gallery.isotope('layout');
			} );
		} );
	}
} );
