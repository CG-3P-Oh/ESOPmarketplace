jQuery( document ).ready( function($) {

	const BREAKPOINT = 768;
	function isMobileMode() {
		return window.innerWidth <= BREAKPOINT;
	}

	// initialize all circles.
	$( '.dipl_interactive_circle' ).each( function() {

		const $circle = $( this );
		const $items  = $circle.find( '.dipl_interactive_circle_item__main' );

		// position items for orbit (desktop) or reset for mobile.
		function positionItems() {
			if ( isMobileMode() ) {
				// mobile mode: reset absolute positioning and show cards.
				$circle.find( '.dipl_interactive_circle_wrap' ).css( 'position', 'static' );
				$items.css( { position: 'relative', left: '', top: '' } );
				$items.parents( '.dipl_interactive_circle_item' ).removeClass( 'active' );
				$circle.addClass( 'mobile-circle' );
				return;
			}

			// Desktop mode: orbit positioning.
			$circle.removeClass( 'mobile-circle' );
			$circle.find( '.dipl_interactive_circle_wrap' ).css( 'position', 'absolute' );
			$items.css( 'position', 'absolute' );

			const size  = $circle.outerWidth();
			const total = $items.length;

			$items.each( function(i) {
				const $it    = $( this );
				const angle  = ( i/total ) * 2 * Math.PI - Math.PI/2; // start top.
				const half   = $it.outerWidth() / 2;
				const radius = size/2 - half - 6; // small inset so it doesn't overflow.

				const x = radius * Math.cos(angle);
				const y = radius * Math.sin(angle);

				$it.css( {
					left: `calc(50% + ${x}px - ${half}px)`,
					top:  `calc(50% + ${y}px - ${half}px)`
				} );
			} ) ;

			// hide all content, then activate first by default.
			$items.parents( '.dipl_interactive_circle_item' ).removeClass( 'active' );
			const $first = $items.first();
			if ( $first.length ) {
				$first.parents( '.dipl_interactive_circle_item' ).addClass( 'active' );
			}
		}

		// bind click handlers only for desktop mode.
		function bindClicks() {
			$items.off( 'click' ); // clear previous handlers.
			if ( ! isMobileMode() ) {
				$items.on( 'click', function(e) {
					e.stopPropagation();
					const $item    = $(this);

					// Hide others.
					$items.not( $item ).parents( '.dipl_interactive_circle_item' ).removeClass( 'active' );

					// Toggle clicked.
					$item.parents( '.dipl_interactive_circle_item' ).addClass( 'active' );
				} );

				// clicking outside closes.
				// $( document ).off( 'click.interactiveCircle' ).on( 'click.interactiveCircle', function() {
				// 	$items.parents( '.dipl_interactive_circle_item' ).removeClass( 'active' );
				// } );
			} else {
				// mobile mode: show everything, don't bind click close.
				$items.parents( '.dipl_interactive_circle_item' ).removeClass( 'active' );
				$( document).off('click.interactiveCircle' );
			}
		}

		// initial layout.
		positionItems();
		bindClicks();

		// on resize, update layout + clicks (debounce small).
		let resizeTimer = null;
		$( window ).on( 'resize.interactiveCircle', function() {
			clearTimeout( resizeTimer );
			resizeTimer = setTimeout( function() {
				positionItems();
				bindClicks();
			}, 80 );
		} );
	} );
} );
