jQuery( document ).ready( function($) {

	// Accordion slide plugin.
	function dipl_accordion_slide_plugin( { swiper, extendParams, on } ) {
		let activeIndex = 0;
		let collapsedWidthPx = 150;

		// Ensure accordionEffect params exist.
		swiper.params.accordionEffect = swiper.params.accordionEffect || {
			slideAspect: "auto",
			collapsedWidth: 150,
			gap: 20,
			slidesShow: 3,
			ease: "ease-in-out",
		};

		// Calculate collapsed width in px from the raw value (px or %)
		const calculateCollapsedWidth = () => {
			const val = swiper.params.accordionEffect.collapsedWidth;
			if ( typeof val === "number" ) {
				return val;
			}
			if ( typeof val === "string" && val.endsWith("%") ) {
				return (swiper.width || swiper.wrapperEl.getBoundingClientRect().width) * (parseFloat(val) / 100);
			}
			return parseFloat(val) || 150;
		};

		const setWrapperHeight = () => {
			const effect = swiper.params.accordionEffect;
			if ( !isNaN( effect.slideAspect ) ) {
				const height = ( swiper.width - (collapsedWidthPx + effect.gap) * (effect.slidesShow - 1) ) / effect.slideAspect;
				$(swiper.wrapperEl).css("height", height + "px");
			}
		};

		const updateAccordionLayout = () => {
			const effect        = swiper.params.accordionEffect;
			const expandedWidth = swiper.width - ( collapsedWidthPx + effect.gap ) * ( effect.slidesShow - 1 );

			let slotsLeft       = effect.slidesShow;

			$( swiper.slides ).each( function(i) {
				const $slide = $(this);
				const offset = i - activeIndex;

				if ( i === activeIndex ) {
					$slide.css({ width: expandedWidth + "px", margin: 0 });
					slotsLeft--;
				} else if (
					offset < 0 &&
					( Math.abs(offset) <= (effect.slidesShow - 1) / 2 || swiper.slides.length - i <= effect.slidesShow )
				) {
					$slide.css( { width: collapsedWidthPx + "px", "margin-right": effect.gap + "px", "margin-left": 0 }) ;
					slotsLeft--;
				} else if (offset > 0 && slotsLeft >= 1) {
					$slide.css( { width: collapsedWidthPx + "px", "margin-left": effect.gap + "px", "margin-right": 0 } );
					slotsLeft--;
				} else {
					$slide.css( { width: 0, margin: 0 } );
				}
			} );
			setWrapperHeight();
		};

		// Add/remove class for slide content.
		const updateActiveContentClass = () => {
			$( swiper.slides ).each( function (i) {
				const $content = $( this ).find( '.dipl_accordion_slider_item_content_inner' );
				if ( i === activeIndex ) {
					$content.addClass( 'et-animated' );
				} else {
					$content.removeClass( 'et-animated' );
				}
			} );
		};

		// Events.
		on( 'beforeInit', () => {
			collapsedWidthPx = calculateCollapsedWidth();
			setWrapperHeight();
		} );
		on( 'init resize', () => {
			collapsedWidthPx = calculateCollapsedWidth();
			setWrapperHeight();
			updateAccordionLayout();
			updateActiveContentClass(); // Add initial state.
		} );
		on( 'activeIndexChange setTranslate', () => {
			collapsedWidthPx = calculateCollapsedWidth();
			activeIndex = swiper.activeIndex;
			updateAccordionLayout();
			updateActiveContentClass(); // update on change.
		} );
		on( 'setTransition', ( swiper, duration ) => {
			const { ease } = swiper.params.accordionEffect;
			$(swiper.slides).css( 'transition', `all ${duration}ms ${ease}` );
		} );
	}

	// Init the swipper.
	function dipl_accordion_slide_init( $thisObj ) {
		const $orderClass       = $thisObj.prop('class').match( /(dipl_accordion_slider\_[^\s]*)/ )[0];
		const $wraperEl         = $thisObj.find( '.dipl_accordion_slider_wrapper' );
		const gap               = parseInt( $wraperEl.attr( 'data-gap' ) || '20px' );
		const slidesShow        = parseInt( $wraperEl.attr( 'data-slides-show' ) ) || 3;
		const rawCollapsedWidth = $wraperEl.attr( 'data-collapsed_width' ) || 150; // "30%" or "150" or "150px".

		const autoplay		   = $wraperEl.attr( 'data-autoplay' ) ?? 'on';
		const pause_on_hover   = $wraperEl.attr( 'data-pause_on_hover' ) ?? 'on';
		const autoplay_speed   = $wraperEl.attr( 'data-autoplay_speed' ) ?? 3000;
		const show_arrow       = $wraperEl.attr( 'data-show_arrow' ) ?? 'on';
		const show_control_dot = $wraperEl.attr( 'data-show_control_dot' ) ?? 'off';
		const dynamic_dots     = $wraperEl.attr( 'data-enable_dynamic_dots' ) ?? 'off';

		let $navigation_arrows = 'false';
		if ( 'on' === show_arrow ) {
			$navigation_arrows = {    
				nextEl: '.' + $orderClass + ' .swiper-button-next',
				prevEl: '.' + $orderClass + ' .swiper-button-prev',
			};
		}
		let $control_dots = false;
		if ( 'on' === show_control_dot ) {
			$control_dots = {
				el: '.' + $orderClass + ' .swiper-pagination',
				dynamicBullets: ( 'on' === dynamic_dots ) ? true : false,
				clickable: true,
			}
		}

		const swiper = new Swiper( '.' + $orderClass + ' .swiper-container', {
			effect: "slide",
			watchSlidesProgress: true,
			virtualTranslate: true,
			loop: false,
			slideToClickedSlide: true,
			allowTouchMove: false,
			pagination: $control_dots,
			navigation: $navigation_arrows,
			grabCursor: true,
			accordionEffect: {
				slideAspect: "auto",
				collapsedWidth: rawCollapsedWidth, // pass raw value
				gap: gap,
				slidesShow: slidesShow,
				ease: "ease-in-out"
			}
		} );

		// Add swiper plugin.
		dipl_accordion_slide_plugin(
			{ swiper, extendParams: swiper.params.extendParams || function(){}, on: swiper.on.bind( swiper ) }
		);

		// Custom autoplay logic.
		let autoplayTimer = null;
		const startAutoplay = () => {
			if ( autoplayTimer ) {
				clearInterval( autoplayTimer );
			}
			if ( 'on' !== autoplay ) {
				return;
			}
			const delay = parseInt( autoplay_speed ) || 3000;

			autoplayTimer = setInterval( () => {
				if ( swiper.destroyed ) return;
				if ( swiper.activeIndex === swiper.slides.length - 1 ) {
					// swiper.slideTo(0); // it start from first again, instead of stop it.
					stopAutoplay();
				} else {
					swiper.slideNext();
				}
			}, delay );
		};
		const stopAutoplay = () => {
			if ( autoplayTimer ) clearInterval( autoplayTimer );
			autoplayTimer = null;
		};

		// Pause on hover
		if ( 'on' === pause_on_hover ) {
			$( '.' + $orderClass + ' .swiper-container' )
				.on( 'mouseenter', stopAutoplay )
				.on( 'mouseleave', startAutoplay );
		}

		// Trigger layout after images load.
		$( window ).on( 'load', function() {
			swiper.update();
			swiper.emit( 'setTranslate' );
			startAutoplay();
		} );

		// Small timeout to ensure first render.
		setTimeout( () => {
			swiper.update();
			swiper.emit( 'setTranslate' );
			startAutoplay();
		}, 50 );

		// Arrows position.
		let $winWidth   = jQuery( window ).width();
		let navigateObj = $thisObj.find('.dipl_swiper_navigation');
		let $arrows     = navigateObj.data();
		if ( $arrows ) {
			if ( $winWidth > 980 && typeof($arrows['arrows_desktop']) !== 'undefined' ) {
				dipl_remove_arrows_classes( navigateObj );
				navigateObj.addClass( 'dipl_arrows_'+$arrows['arrows_desktop'] );
			}
			if ( $winWidth < 981 ) {
				if ( typeof($arrows['arrows_tablet']) !== 'undefined' ) {
					dipl_remove_arrows_classes( navigateObj );
					navigateObj.addClass('dipl_arrows_'+$arrows['arrows_tablet']);
				} else if ( typeof($arrows['arrows_desktop']) !== 'undefined' ) {
					dipl_remove_arrows_classes( navigateObj );
					navigateObj.addClass('dipl_arrows_'+$arrows['arrows_desktop']);
				}
			}
			if ( $winWidth < 768 ) {
				if ( typeof($arrows['arrows_phone']) !== 'undefined' ) {
					dipl_remove_arrows_classes( navigateObj );
					navigateObj.addClass('dipl_arrows_'+$arrows['arrows_phone']);
				} else if ( typeof($arrows['arrows_tablet']) !== 'undefined' ) {
					dipl_remove_arrows_classes( navigateObj );
					navigateObj.addClass('dipl_arrows_'+$arrows['arrows_tablet']);
				} else if ( typeof($arrows['arrows_desktop']) !== 'undefined' ) {
					dipl_remove_arrows_classes( navigateObj );
					navigateObj.addClass('dipl_arrows_'+$arrows['arrows_desktop']);
				}
			}
		}
	}

	// Init swipper plugin.
	$( '.dipl_accordion_slider' ).each( function() {
		dipl_accordion_slide_init( $( this ) );
	} );

	$( window ).resize( function() {
		let $winWidth = $(window).width();
		if ( $( document ).find('.dipl_accordion_slider').length > 0 ) {
			$( document ).find('.dipl_accordion_slider').each( function() {
				let navigateObj = $( this ).find('.dipl_swiper_navigation');
				let $arrows     = navigateObj.data();
				if ( $arrows ) {
					if ( $winWidth > 980 && typeof( $arrows['arrows_desktop'] ) !== 'undefined' ) {
						dipl_remove_arrows_classes( navigateObj );
						navigateObj.addClass( 'dipl_arrows_' + $arrows['arrows_desktop'] );
					}
					if ( $winWidth < 981 ) {
						if ( typeof( $arrows['arrows_tablet'] ) !== 'undefined' ) {
							dipl_remove_arrows_classes( navigateObj );
							navigateObj.addClass( 'dipl_arrows_' + $arrows['arrows_tablet'] );
						} else if ( typeof($arrows['arrows_desktop']) !== 'undefined' ) {
							dipl_remove_arrows_classes( navigateObj );
							navigateObj.addClass( 'dipl_arrows_' + $arrows['arrows_desktop'] );
						}
					}
					if ( $winWidth < 768 ) {
						if ( typeof( $arrows['arrows_phone'] ) !== 'undefined' ) {
							dipl_remove_arrows_classes( navigateObj );
							navigateObj.addClass( 'dipl_arrows_' + $arrows['arrows_phone'] );
						} else if ( typeof( $arrows['arrows_tablet'] ) !== 'undefined' ) {
							dipl_remove_arrows_classes( navigateObj );
							navigateObj.addClass( 'dipl_arrows_' + $arrows['arrows_tablet'] );
						} else if ( typeof( $arrows['arrows_desktop'] ) !== 'undefined' ) {
							dipl_remove_arrows_classes( navigateObj );
							navigateObj.addClass( 'dipl_arrows_' + $arrows['arrows_desktop'] );
						}
					}
				}
			} );
		}
	} );

	function dipl_get_arrows_classes() {
		return [
			'dipl_arrows_top_left', 'dipl_arrows_top_center', 'dipl_arrows_top_right',
			'dipl_arrows_bottom_left', 'dipl_arrows_bottom_center', 'dipl_arrows_bottom_right',
			'dipl_arrows_outside', 'dipl_arrows_inside',
		];
	}

	function dipl_remove_arrows_classes( $element ) {
		let $arrowClasses = dipl_get_arrows_classes();
		$element.removeClass( $arrowClasses.join(' ') );
	}
} ); // Over document ready.
